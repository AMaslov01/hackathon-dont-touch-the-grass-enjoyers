# Руководство по миграции к системе бизнесов и сотрудников

## Обзор изменений

Были внесены следующие изменения в систему:

### 1. Новая структура базы данных

#### Таблица `businesses`
Хранит информацию о бизнесах:
- `id` - ID бизнеса
- `owner_id` - ID владельца (ссылка на users.user_id)
- `business_name` - Название бизнеса
- `business_type` - Тип бизнеса и описание
- `financial_situation` - Финансовая ситуация
- `goals` - Цели бизнеса
- `created_at`, `updated_at` - Временные метки

#### Таблица `employees`
Хранит связи сотрудников с бизнесами:
- `id` - ID записи
- `business_id` - ID бизнеса
- `user_id` - ID пользователя
- `status` - Статус (pending/accepted/rejected)
- `invited_at` - Дата приглашения
- `responded_at` - Дата ответа на приглашение

### 2. Изменения в таблице `users`
- **Удалена колонка** `business_info` (данные перенесены в таблицу `businesses`)
- Остались колонки `workers_info` и `executors_info` для других целей

## Инструкции по миграции

### Шаг 1: Обновить зависимости
```bash
pip install -r requirements.txt
```

### Шаг 2: Создать новые таблицы в базе данных
```bash
python setup_database.py
```
Это создаст таблицы `businesses` и `employees`.

### Шаг 3: Мигрировать существующие данные
```bash
python migrate_to_businesses.py
```
Этот скрипт:
- Перенесет данные из `users.business_info` в таблицу `businesses`
- Создаст запись бизнеса для каждого пользователя с заполненной `business_info`
- Для бизнесов без названия сгенерирует название на основе типа бизнеса

### Шаг 4: (Опционально) Удалить старую колонку
После успешной миграции можно удалить колонку `business_info`:
```sql
ALTER TABLE users DROP COLUMN business_info;
```

**Важно:** Рекомендуется сначала создать бэкап базы данных!

## Новые функции

### Для владельцев бизнеса:

1. **Создание бизнеса**
   - Используйте команду `/finance`
   - Теперь включает вопрос о названии бизнеса (вопрос 1/4)

2. **Приглашение сотрудников**
   ```
   /add_employee @username
   ```
   - Отправляет приглашение пользователю стать сотрудником
   - Пользователь получит уведомление в боте

3. **Просмотр сотрудников**
   ```
   /employees
   ```
   - Показывает список принятых сотрудников
   - Показывает ожидающие приглашения

### Для сотрудников:

1. **Просмотр приглашений**
   ```
   /invitations
   ```
   - Показывает все ожидающие приглашения

2. **Принять приглашение**
   ```
   /accept <id>
   ```
   - ID берется из списка приглашений

3. **Отклонить приглашение**
   ```
   /reject <id>
   ```

4. **Просмотр бизнесов**
   ```
   /my_businesses
   ```
   - Показывает бизнесы, где вы являетесь сотрудником

## Изменения в командах

### `/finance` (обновлено)
Теперь включает 4 вопроса вместо 3:
1. Название бизнеса
2. Тип бизнеса и описание
3. Финансовая ситуация
4. Цели и задачи

### `/start` и `/help` (обновлено)
Добавлена информация о новых командах управления сотрудниками.

### `/find_similar` (обновлено)
Обновлена логика для работы с новой структурой таблицы `businesses`.

## API изменения

### Новые методы в `user_manager`:
- `get_business(user_id)` - получить бизнес пользователя
- `is_business_owner(user_id)` - проверить, является ли владельцем
- `is_employee(user_id, business_id)` - проверить, является ли сотрудником
- `invite_employee(owner_id, username)` - пригласить сотрудника
- `get_pending_invitations(user_id)` - получить приглашения
- `respond_to_invitation(invitation_id, accept)` - ответить на приглашение
- `get_employees(business_id)` - получить сотрудников
- `get_user_businesses(user_id)` - получить бизнесы пользователя

### Обновленные методы:
- `save_business_info()` - теперь требует `business_name` как первый параметр
- `get_business_info()` - теперь возвращает данные из таблицы `businesses`

## Откат изменений

Если нужно откатить изменения:

1. Восстановить бэкап базы данных
2. Вернуться к предыдущей версии кода:
   ```bash
   git checkout <previous_commit>
   ```

## Тестирование

После миграции протестируйте:

1. ✅ Создание нового бизнеса через `/finance`
2. ✅ Приглашение сотрудника через `/add_employee`
3. ✅ Принятие/отклонение приглашений
4. ✅ Просмотр списка сотрудников
5. ✅ Генерация финансового плана с существующими данными
6. ✅ Поиск похожих пользователей через `/find_similar`

## Поддержка

При возникновении проблем:
1. Проверьте логи бота
2. Убедитесь, что миграция прошла успешно
3. Проверьте, что все таблицы созданы корректно

## Схема базы данных

```
users                    businesses                employees
┌─────────────┐         ┌──────────────┐         ┌──────────────┐
│ user_id (PK)│◄────────│ owner_id (FK)│         │ id (PK)      │
│ username    │         │ id (PK)      │◄────────│ business_id  │
│ ...         │         │ business_name│         │ user_id (FK) │◄──┐
└─────────────┘         │ business_type│         │ status       │   │
                        │ ...          │         │ ...          │   │
                        └──────────────┘         └──────────────┘   │
                                                         │            │
                                                         └────────────┘
```

## Версия
Версия: 2.0.0
Дата: 2024

