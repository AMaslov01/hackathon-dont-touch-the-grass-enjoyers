# 🔄 Диаграмма работы функции /finance

## 📊 Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                      Пользователь отправляет                    │
│                            /finance                             │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│            finance_start() - Точка входа                        │
│  • Создает/получает пользователя                                │
│  • Проверяет наличие business_info                              │
└───────────────────────────┬─────────────────────────────────────┘
                            │
              ┌─────────────┴─────────────┐
              │                           │
        Есть данные?                 Нет данных?
              │                           │
              ▼                           ▼
┌─────────────────────────┐   ┌──────────────────────────┐
│  CHECKING_EXISTING      │   │  QUESTION_1              │
│  Предложить выбор:      │   │  Спросить о бизнесе      │
│  • Обновить (да)        │   └────────────┬─────────────┘
│  • Использовать (нет)   │                │
└──────────┬──────────────┘                │
           │                               ▼
     ┌─────┴──────┐          ┌──────────────────────────┐
     │            │          │  finance_question_1()    │
    да          нет         │  • Сохранить ответ       │
     │            │          │  • Контекст для Q2       │
     ▼            │          └────────────┬─────────────┘
┌─────────────┐   │                       │
│ QUESTION_1  │   │                       ▼
└──────┬──────┘   │          ┌──────────────────────────┐
       │          │          │  QUESTION_2              │
       │          │          │  Спросить о финансах     │
       │          │          └────────────┬─────────────┘
       ▼          │                       │
┌─────────────┐   │                       ▼
│ QUESTION_2  │   │          ┌──────────────────────────┐
└──────┬──────┘   │          │  finance_question_2()    │
       │          │          │  • Сохранить ответ       │
       │          │          │  • Контекст для Q3       │
       ▼          │          └────────────┬─────────────┘
┌─────────────┐   │                       │
│ QUESTION_3  │   │                       ▼
└──────┬──────┘   │          ┌──────────────────────────┐
       │          │          │  QUESTION_3              │
       │          │          │  Спросить о целях        │
       ▼          │          └────────────┬─────────────┘
       │          │                       │
       │          │                       ▼
       │          │          ┌──────────────────────────┐
       │          │          │  finance_question_3()    │
       │          │          │  • Сохранить ответ       │
       │          │          │  • Сохранить в БД        │
       └──────────┴──────────┴────────────┬─────────────┘
                                          │
                                          ▼
                         ┌────────────────────────────────┐
                         │  finance_generate_plan()       │
                         │  1. Проверить токены (3)       │
                         │  2. Получить business_info     │
                         │  3. Вызвать AI                 │
                         │  4. Отправить план             │
                         │  5. Залогировать               │
                         └────────────────┬───────────────┘
                                          │
                                          ▼
                         ┌────────────────────────────────┐
                         │  ConversationHandler.END       │
                         │  • Очистить context            │
                         │  • Завершить диалог            │
                         └────────────────────────────────┘
```

## 🔀 Альтернативные пути

### Отмена процесса (/cancel)

```
Любое состояние
       │
       │ /cancel
       ▼
┌──────────────────┐
│ finance_cancel() │
│ • Сообщение      │
│ • Очистить data  │
└────────┬─────────┘
         │
         ▼
  ConversationHandler.END
```

### Недостаточно токенов

```
finance_generate_plan()
       │
       │ Проверка токенов
       ▼
  tokens < 3?
       │
       │ Да
       ▼
┌──────────────────┐
│ Сообщение об     │
│ ошибке + время   │
│ следующего       │
│ обновления       │
└────────┬─────────┘
         │
         ▼
  ConversationHandler.END
```

### Ошибка AI

```
ai_client.generate_financial_plan()
       │
       │ Exception
       ▼
┌──────────────────┐
│ Сообщение об     │
│ ошибке AI        │
└────────┬─────────┘
         │
         ▼
  ConversationHandler.END
```

## 🗄️ Взаимодействие с базой данных

```
┌─────────────────────────────────────────────────────────────┐
│                         bot.py                              │
│                     (Обработчики)                           │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ Вызовы методов
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                     user_manager.py                         │
│  • get_business_info()                                      │
│  • save_business_info()                                     │
│  • has_business_info()                                      │
│  • process_request()                                        │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ Преобразование данных
                         │ JSON ⟷ dict
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                     database.py                             │
│                   (UserRepository)                          │
│  • get_business_info() → SQL SELECT                         │
│  • save_business_info() → SQL UPDATE                        │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ SQL запросы
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    PostgreSQL Database                      │
│  Table: users                                               │
│  Column: business_info TEXT (JSON)                          │
└─────────────────────────────────────────────────────────────┘
```

## 🤖 Взаимодействие с AI

```
┌─────────────────────────────────────────────────────────────┐
│                 finance_generate_plan()                     │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ business_info dict
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              ai_client.generate_financial_plan()            │
│  1. Создать system_prompt (финансовый консультант)          │
│  2. Создать user_prompt с бизнес-данными                    │
│  3. Вызвать generate_response()                             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ HTTP POST
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                  OpenRouter API                             │
│  Model: config.AI_MODEL                                     │
│  Timeout: 60 секунд                                         │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ JSON response
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                 Финансовый план (текст)                     │
│  • Анализ                                                   │
│  • Рекомендации                                             │
│  • Стратегии                                                │
│  • План действий                                            │
│  • Прогноз                                                  │
│  • Риски                                                    │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ Возврат в bot.py
                         ▼
┌─────────────────────────────────────────────────────────────┐
│           Отправка пользователю через Telegram              │
│  • Если > 4000 символов → разбить на части                  │
│  • Если Markdown fail → plain text                          │
└─────────────────────────────────────────────────────────────┘
```

## 📊 Структура данных

### Context.user_data (временное хранилище во время диалога)

```python
context.user_data = {
    'business_type': str,        # Ответ на вопрос 1
    'financial_situation': str,  # Ответ на вопрос 2
    'goals': str                 # Ответ на вопрос 3
}
```

### Database.business_info (постоянное хранилище)

```json
{
  "business_type": "Кофейня в центре города...",
  "financial_situation": "Месячный оборот 500к...",
  "goals": "Увеличить прибыль на 30%...",
  "updated_at": "2025-11-13T10:30:00"
}
```

## 🎯 Состояния ConversationHandler

```
┌───────────────────────────────────────────────────────────┐
│  CHECKING_EXISTING (0)                                    │
│  ↓ Ожидает: "да" или "нет"                                │
│  ↓ Обрабатывает: finance_check_existing()                 │
└───────────────────────────────────────────────────────────┘
                         │
         ┌───────────────┴────────────────┐
         ▼                                ▼
┌──────────────────┐           ┌──────────────────┐
│  QUESTION_1 (1)  │           │  Генерация плана │
│  Ожидает: текст  │           │  с текущими      │
│  Обработка:      │           │  данными         │
│  question_1()    │           └──────────────────┘
└────────┬─────────┘
         ▼
┌──────────────────┐
│  QUESTION_2 (2)  │
│  Ожидает: текст  │
│  Обработка:      │
│  question_2()    │
└────────┬─────────┘
         ▼
┌──────────────────┐
│  QUESTION_3 (3)  │
│  Ожидает: текст  │
│  Обработка:      │
│  question_3()    │
└────────┬─────────┘
         ▼
┌──────────────────┐
│  Генерация плана │
│  с новыми данными│
└──────────────────┘
```

## 🔐 Проверка токенов

```
┌─────────────────────────────────────────────────┐
│         user_manager.process_request()          │
│                (tokens_amount=3)                │
└──────────────────────┬──────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│     check_and_refresh_tokens()                  │
│  • Проверить last_token_refresh                 │
│  • Если прошло 24ч → обновить до max_tokens     │
└──────────────────────┬──────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│         has_enough_tokens(user_id, 3)?          │
└──────────────────────┬──────────────────────────┘
                       │
         ┌─────────────┴─────────────┐
         ▼                           ▼
    ✅ Да (tokens ≥ 3)          ❌ Нет (tokens < 3)
         │                           │
         ▼                           ▼
┌──────────────────┐      ┌──────────────────────┐
│ use_tokens(3)    │      │ return (False, time) │
│ tokens -= 3      │      └──────────────────────┘
│ return (True, _) │
└──────────────────┘
```

## 📝 Логирование

```
┌─────────────────────────────────────────────────────────┐
│                    На каждом этапе                      │
└────────────────────────┬────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ logger.info  │  │ logger.error │  │ logger.warn  │
│ Успешные     │  │ Ошибки       │  │ Предупрежд.  │
│ операции     │  │              │  │              │
└──────────────┘  └──────────────┘  └──────────────┘
         │               │               │
         └───────────────┼───────────────┘
                         ▼
              ┌──────────────────────┐
              │  Console / Log File  │
              │  Формат:             │
              │  timestamp - name -  │
              │  level - message     │
              └──────────────────────┘
```

## 🚦 Пример полного флоу

```
User: /finance
  ↓
Bot: "💼 Финансовый ассистент..."
Bot: "📊 Вопрос 1/3..."
  ↓
User: "Кофейня в центре..."
  ↓ [Сохранено в context]
Bot: "💰 Вопрос 2/3 (о вашей Кофейне...)..."
  ↓
User: "Месячный оборот 500к..."
  ↓ [Сохранено в context]
Bot: "🎯 Вопрос 3/3..."
  ↓
User: "Хочу увеличить прибыль..."
  ↓ [Сохранено в context + DB]
Bot: "✅ Информация сохранена!"
Bot: "🔄 Анализирую..."
  ↓ [Проверка токенов: OK, списано 3]
  ↓ [Запрос к AI]
  ↓ [Получен план]
Bot: "💼 Финансовый план\n\n[подробный план]..."
  ↓ [Залогировано]
  ↓ [Очищен context]
[Диалог завершен]
```

---

**Примечание**: Диаграммы показывают логический флоу. Фактическая реализация может содержать дополнительные проверки и обработку ошибок.


